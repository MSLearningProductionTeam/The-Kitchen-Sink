<html>
  <head>
    <style>
    /*global styles*/
    .correct_color{background-color: rgb(28, 203, 33) !important;}
    .incorrect_color{background-color: rgb(251, 51, 51) !important;}
    .hidden{display:none !important;}
    .flexibleDisplay{display: flex;}
    .fillContentArea{min-width: 100%; max-width: 100%;}
    .subText{font-size: 12px; margin: 5px 0 5px 0;}
    .hyperLinkBlue{color:#0061A7 !important;}
    body{background:#E6E6E6!important;}
    textarea{resize: none;}

    #ninjaTile{width: 100px; height: 100px; position: absolute; left: 795px; top:50px; background: white; z-index: 2;}
    #ninjaButton{width: 90px; position: absolute; left: 795px; top: 50px; z-index: 1;}
    #ninjaCat{width: 200px; position: absolute; z-index: 3;}

    #intakeFormContentContainer{position: relative; left: 50%; transform: translateX(-50%); width: 910px; background: white; padding-bottom: 1px;}
      #intakeFormContentContainer p {margin:10px; font-family: "SegoeUI Light", "Segoe UI","Helvetica Neue",Helvetica,Arial,sans-serif; font-size: 14px;}
      #intakeFormThankYou{text-align: center; margin-bottom: 10px;}
        #intakeFormThankYou h1, #intakeFormThankYou h3 {color:#243b56;}
      .intakeFormBanner{background:#243b56; padding:10px 5px 5px 15px; color:white; font-size: 14px; font-family: "SegoeUI Light", "Segoe UI","Helvetica Neue",Helvetica,Arial,sans-serif; height: 40px; display: flex; justify-content: space-between; vertical-align:middle;}
        #formDateTime{float:right; font-size: 14px !important; width:450px; text-align: right;}
      #formselectionContainer{margin:15px;}
        #selectionLinks {float:right;}
        #formselectionContainer .flexibleDisplay p{font-size:14px !important;}
        #formSelectionItem{background:#e7ffe7; width: 225px; margin-top:5px; margin-left: 10px; border-radius:7px;}
          #formSelectionItem .typeOfRequest{padding:5px; cursor:pointer;}
          #formSelectionItem .typeOfRequest:hover{background:rgb(172, 177, 170); border-radius: 7px;}
          #formSelectionItem .typeOfRequest:hover{background:rgb(172, 177, 170); border-radius: 7px;}
          #formSelectionItem .typeOfRequest.selected{background:rgb(172, 177, 170); color:white; border-radius: 7px;}
      #intakeFormContainer{position: relative; /*left:-1000px;*/ width: 864px; left: 50%; transform: translate3d(-50%,0,0); margin-top:10px; margin-bottom:10px;}
        .intakeFormSection{border: 1px solid rgb(228, 233, 246); display: flex; font-size:14px; margin:-1px;}
          .formSectionTitle{padding:10px; width: 185px; min-width: 185px; border-right: 1px solid rgb(228, 233, 246); text-align: right; font-family: "SegoeUI Light", "Segoe UI","Helvetica Neue",Helvetica,Arial,sans-serif;}
            .formSectionTitle ul li{list-style-type: none; font-size:12px; }
          .formSectionInput{margin:10px; flex-grow: 1; align-self: center;}
            #ownerInput{width: 295px;}
            #coownerInput{width: 295px;}
            #attachmentInput{color:black !important;}
            #autocomplete{width: 295px; background: white; border: 1px solid lightgray; border-top: none; position: absolute;}
              #autocomplete div{padding: 5px; cursor: pointer;}
              #autocomplete div:hover{background: lightgray;}
            #datePicker{position: relative;; z-index: 1; top:-100px; left:180px;}
              .ui-datepicker-inline{background:white; border: 1px solid lightgray; padding:5px; position: absolute;}
                .ui-widget-header{border: none !important; background:#243b56 !important;}
                .ui-state-default, .ui-widget-content .ui-state-default{border: 1px solid lightgrey !important; background: lightgrey !important; font-weight: normal !important; color: white !important;}
                .ui-state-active, .ui-widget-content .ui-state-active {border: 1px solid #243b56 !important; background: #243b56 !important; font-weight: normal !important; color: #ffffff !important;}
                .ui-datepicker-next-hover, .ui-state-hover{border:none !important; background: none !important;}
                .ui-widget-content{color:black !important; cursor: pointer !important; text-align: center !important;}
          .seeExampleButton{background:rgb(237, 235, 235); border:1px solid rgb(213, 217, 211);  width: 20px; height: 20px; margin: 10px 10px 10px 5px;}
          .seeExampleButton:hover{background: rgb(109, 112, 109);}
          .seeExampleButton.selected{background: rgb(109, 112, 109);}
          .seeExampleImage{margin:0 0 0 0px;}
        #buttonContainer{display:flex; flex-direction: column;}
          .inputBtn{cursor: pointer; background:#243b56; padding:10px; margin-right:10px; color:white; text-align: center;}
          .loadingImg{width: 20px; height: 20px; margin: 0px auto;}
          #submitLoadingText{margin:5px; text-align: center;}
          #addBtn{width:200px; font-size: 14px;margin: 0px auto; margin-bottom: 5px; margin-top: 5px; border-radius:6px;}
          .thankYouBtn{width: 140px; margin-bottom: 10px !important; margin:0px auto;}
    </style>
    <script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
  <script
  src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
  integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
  crossorigin="anonymous"></script>
    <script>
    window.onload = function(){
      //globals
      //absolute url path to sp list
      var siteUrl;
      //timer for the people search function
      var peoplePickerTimer;
      //timer to show and hide the attachment loading circle
      var loadingTimer;
      //array of object containing the data on all attached files
      var attachedFileData;
      //the attached files in the file input
      var attachmentFiles;
      //array of the days of the week
      var daysOfTheWeek;
      //array of the months in the year
      var monthsOfTheYear;


      init();

      function init(){
        //initalize variables
        attachedFileData = [];
        daysOfTheWeek = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturdate"];
        monthsOfTheYear = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        //define the siteUrl variable if the _spPageContextInfo object exists
        if(typeof _spPageContextInfo !== 'undefined'){siteUrl = _spPageContextInfo.webAbsoluteUrl;}

        //initalize the date picker element
        //this is a jquery ui widget
        $("#datePicker").datepicker({
          //when a user selects a date update the publishDateInput with the selected value and close the date picker
          onSelect: function(date,instance){
            $("#publishDateInput").val(date);
            $("#datePicker").addClass("hidden");
          },
        });
        //append a close button to the date picker
        $(".ui-datepicker-inline").append("<div id='datePickerClose'>Close</div>");

        //before doing anything else make a request for the user information to set the greeting
        // and to set the top right banner information
        setGreetingName().then(function(){
          //once the request has completed show the selection container and add the events to the form
          //this prevents the user from trying to make a form selection before the greeting has been set and the events have been attached
          $("#formselectionContainer").removeClass("hidden");
          //attach the events to the controls
          attachEvents();
        });

      }

      //checks that all inputs that are going to be submited are valid
      function validateForm(){
        //initalize the deferred object
        //will resolve if all inputs are valid, reject if any of the inputs are invalid
        var validationDeferred = $.Deferred();
        //get the files to read
        attachmentFiles = typeof $("#attachmentInput:visible")[0] !== "undefined" ? $("#attachmentInput:visible")[0].files : undefined;


        //check that all required inputs are filled in and valid
        $("#intakeFormContainer .intakeFormSection:visible .requiredInput").each(function(){
          //if the input is blank or null or is invalid mark the input invalid and turn it red
          if(($(this).val() == "" || $(this).val() == null)){
            $(this).addClass("invalid");
            $(this).addClass("incorrect_color");
            $(this).removeClass("valid");
          }
          //if the input is not blank but has already been determined incorrect set it as invalid
          //Note: this is only used for the owner and co-owner fields at the moment
          else if($(this).hasClass("#incorrect_response")){
            $(this).addClass("invalid");
            $(this).removeClass("valid");
          }
          //otherwise validate the input
          else{
            $(this).addClass("valid");
            $(this).removeClass("incorrect_color");
            $(this).removeClass("invalid");
          }
        });
        //check all optionl inputs
        $("#intakeFormContainer .intakeFormSection:visible .optionalInput").each(function(){
          //if the input is not blank and the value is not null and the value has not been marked as inccorect
          // or if the value is blank mark the input as valid
          if(($(this).val() !== "" && $(this).val() !== null && !$(this).hasClass("incorrect_response")) || ($(this).val() == "")){
            $(this).addClass("valid");
            $(this).removeClass("incorrect_color");
            $(this).removeClass("invalid");
          }
          //otherwise mark the input as invalid and make it red
          else{
            $(this).addClass("invalid");
            $(this).addClass("incorrect_color");
            $(this).removeClass("valid");
          }
        });
        var promises = [];
        //loop through all attachments and add a promise to the promise array
        $.each(attachmentFiles,function(){
          promises.push(readFile(this,fileReadSucess,fileReadFail));
        });
        //read the file in the file input before checking for final validation
        $.when.apply($, promises).then(function(e){
          console.log("all files read");
          //if any of the visible inputs is invalid or not marked as valid reject the promise
          if($("#intakeFormContainer .intakeFormSection:visible .formInput").hasClass("invalid") || !$("#intakeFormContainer .intakeFormSection:visible .formInput").hasClass("valid")){
            alert("Please fill in all fields with the correct information");
            //reject the promise
            validationDeferred.reject("All fields were not filled in properly");
          }
          //otherwise all information provided is valid and resolve the promise
          else{
            validationDeferred.resolve("All fields contain vailid data");
          }
        });

        return validationDeferred.promise();

      }


      //the object that is used to make the new sp list item
      function gatherFormData(){
        var requestType = $(".typeOfRequest.selected").html();
        var title = "Windows Devices Group - Publishing Request ("+requestType+")";
        //object containing the data to send to sharepoint
        var itemData = {
          '__metadata': {'type': "SP.Data.WDGIntakeFormListItem"},
          'RequestType1': requestType,
          'Title': title
        };
        //add all visible and valid input values to the object
        $("#intakeFormContainer .intakeFormSection:visible .formInput.valid").each(function(){
          //ignore the attachements input for now and do not add it as there is no sharepoint list column to accept it
          if($(this).attr("data-property")!== "Attachments"){
            itemData[$(this).attr("data-property")] = $(this).val();
          }
        });

        return itemData;
      }


        //creates a new SP list item
        //itemProperties => an object containing all the properties of the new list item you want to create EX. Title, description, etc.
        //attachment => the object containing all attachment data, if there is any
        function createListItem(itemProperties,attachment){
          //before the request make sure you obtain a new form digest value and the list type
          $.when(
            getFormDigest(),
            getListType()
          ).then(function(data){
            $.ajax({
                url: siteUrl + "/_api/web/lists/getbytitle('WDGIntakeForm')/items",
                type: "POST",
                contentType: "application/json;odata=verbose",
                data: JSON.stringify(itemProperties),
                headers: {
                    "Accept": "application/json;odata=verbose",
                    "X-RequestDigest": data[0].d.GetContextWebInformation.FormDigestValue
                },
                success: function (successData) {
                  var itemId = successData.d.Id;
                  var typeofRequest = $(".typeOfRequest.selected").attr("data-footerVal");
                  //check if there is an attachment
                  //if there is send all the attached file to the newly created sharepoint list item
                  if(typeof attachmentFiles !== "undefined"){
                    var promise = $.Deferred();
                    promise.promise();
                    sendAttachments(itemId,attachment,promise);
                    //when the promise passed to sendAttachments resolves show the thank you screen or show the error
                    $.when(promise).then(function(e){
                      //stop the loading timer and hide the image
                      clearTimeout(loadingTimer);
                      $("#submitLoadingImage").addClass("hidden");
                      $("#submitLoadingText").addClass("hidden");
                      console.log("Created new list item ");
                      $("#addBtn").removeClass("disabled");
                      showThankYou(itemId,typeofRequest);
                    },function(data){
                      //stop the loading timer and hide the image
                      clearTimeout(loadingTimer);
                      $("#submitLoadingImage").addClass("hidden");
                      $("#submitLoadingText").addClass("hidden");
                      alert("There was an error with the attached file.");
                      $("#addBtn").removeClass("disabled");
                      console.log(data);
                        throw new Error("There was an error in attaching the file to the sharepoint list");
                    });
                  }
                  //if there is no attachment alert that a new item has been created
                  else{
                    //stop the loading timer and hide the image
                    clearTimeout(loadingTimer);
                    $("#submitLoadingImage").addClass("hidden");
                    $("#submitLoadingText").addClass("hidden");
                    console.log("Created new list item ");
                    $("#addBtn").removeClass("disabled");
                    showThankYou(itemId,typeofRequest);
                  }
                },
                error: function (data) {
                  //stop the loading timer and hide the image
                  clearTimeout(loadingTimer);
                  $("#submitLoadingImage").addClass("hidden");
                  $("#submitLoadingText").addClass("hidden");
                  alert("There was an error with writing to the sharepoint list");
                  $("#addBtn").removeClass("disabled");
                  console.log(data);
                  throw new Error("There was an error in writing to the sharepoint list");
                }
            });
          });
        }

        //get a new digest value for the Form
        //the digest value prevents the same form submission from being applied multiple times
        function getFormDigest() {
            return $.ajax({
                url: siteUrl + "/_api/contextinfo",
                method: "POST",
                headers: { "Accept": "application/json; odata=verbose" },
                success: function(data){
                  console.log("Obtained new form digest " +data.d.GetContextWebInformation.FormDigestValue);
                }
            });
        }
        //gets the SP list type
        //used when making an api request
        function getListType(){
          return $.ajax({
            url: siteUrl + "/_api/web/lists/getbytitle('WDGIntakeForm')/items",
            Type:'GET',
            headers: {
              accept: "application/json;odata=verbose"
            },
            success: function(data){
              console.log("Obtained list type: "+data);
            }
          });
        }


        //sends a file or files to a sharepoint list item as an attchment of that list item
        //itemId => the id of the sharepoint list item you want to attach the file to
        //attachment => and array of objects where each object is an attached file containing the name of the file and the file data
        //deferedPromise => a promise passed to the function wich will resolve when all files have been sent
        function sendAttachments(itemId,attachmentArray,deferredPromise){
          if(attachmentArray.length <= 0){
            deferredPromise.resolve("All attachments sent");
            return;
          }
          else{
            $.when(getFormDigest()).then(function(data){
              $.ajax({
                url: siteUrl + "/_api/web/lists/getbytitle('WDGIntakeForm')/items("+itemId+")/AttachmentFiles/add(FileName='"+attachmentArray[0].fileName+"')",
                type: "POST",
                data: attachmentArray[0].fileString,
                processData: false,
                headers: {
                    "Accept": "application/json;odata=verbose",
                    "content-type": "application/json; odata=verbose",
                    "X-RequestDigest":  data.d.GetContextWebInformation.FormDigestValue
                },
                success: function (data) {
                  console.log("Attached file to list item");
                  attachmentArray.shift();
                  sendAttachments(itemId,attachmentArray,deferredPromise);
                },
                error: function (data) {
                  console.log(data);
                  deferredPromise.reject("there was an error with one or more of the attachments");
                }
              });
            });
          }
        }


        //checks sharepoint for a valid user
        // user => the user to query for
        // inputField => the input box the user is typing into
        function searchForUser(user,inputField){
          $.when(
            getFormDigest()
          ).then(function(data){
          $.ajax({
              url: siteUrl + "/_api/SP.UI.ApplicationPages.ClientPeoplePickerWebServiceInterface.clientPeoplePickerSearchUser",
              type: "POST",
              data:JSON.stringify({
                  'queryParams':{
                      '__metadata':{
                          'type':'SP.UI.ApplicationPages.ClientPeoplePickerQueryParameters'
                      },
                      'AllowEmailAddresses':true,
                      'AllowMultipleEntities':false,
                      'AllUrlZones':false,
                      'MaximumEntitySuggestions':5,
                      'Required': true,
                      'PrincipalSource':15,
                      'PrincipalType': 1,
                      'QueryString': user
                  }
              }),
              contentType: "application/json;odata=verbose",
              headers: {
                  "Accept": "application/json;odata=verbose",
                  "X-RequestDigest": data.d.GetContextWebInformation.FormDigestValue
              },
              success: function (data) {
                var results = JSON.parse(data.d.ClientPeoplePickerSearchUser);
                console.log(results);
                //if the object returns more then 1 result display the suggestion box with all returned people
                if(results.length >= 2){
                    var suggestions = "";
                    $.each(results,function(i,val){
                      suggestions += "<div>"+this.DisplayText+"</div>";
                    });


                      $("#"+inputField).next().html(suggestions);
                      $("#"+inputField).next().removeClass("hidden");

                      //add the click event to the newly created suggestion elements
                      $("#"+inputField).next().children().on("click",function(){
                        //update the value in the text input to the value clicked on
                        $(this).parent().prev().val($(this).html());
                        //hide the suggestion box
                        $(this).parent().addClass("hidden");
                        //add the correct color and response class and remove the inccorect color and response class
                        $(this).parent().prev().removeClass('incorrect_response');
                        $(this).parent().prev().removeClass('incorrect_color');
                        $(this).parent().prev().addClass('correct_response');
                        $(this).parent().prev().addClass('correct_color');
                      });

                      //remove the correct and incorrect classes
                      $("#"+inputField).removeClass('correct_response');
                      $("#"+inputField).removeClass('correct_color');
                      $("#"+inputField).removeClass('incorrect_response');
                      $("#"+inputField).removeClass('incorrect_color');
                }
                //if no results are returned consider the input incorrect
                else if(results.length <= 0){
                  $("#"+inputField).addClass('incorrect_response');
                  $("#"+inputField).addClass('incorrect_color');
                  $("#"+inputField).removeClass('correct_response');
                  $("#"+inputField).removeClass('correct_color');
                  $("#"+inputField).next().addClass("hidden");
                }
                //if the search returns a single result consider it valid and update the text in the input box
                else if(results.length == 1){
                  $("#"+inputField).removeClass('incorrect_response');
                  $("#"+inputField).removeClass('incorrect_color');
                  $("#"+inputField).val(results[0].DisplayText);
                  $("#"+inputField).addClass('correct_response');
                  $("#"+inputField).addClass('correct_color');
                  $("#"+inputField).next().addClass("hidden");
                }
              },
              error: function (data) {
                console.log(data);
                 throw new Error("There was an issue with querying for the specified user");
              }
            });
          });
        }

        //display the correct input fields based on which form is selected
        // form => the class of the form you want to display
        // footer => value of the new footer to display
        function swapFormContent(form,footer){
          //show the form container since it starts hidden
          $("#intakeFormContainer").removeClass("hidden");
          //hide all forms
          $(".intakeFormSection").addClass("hidden");
          //show the selected form
          $("."+form).removeClass("hidden");
          //change the footer value
          $("#intakeFormFooter").html(footer);
        }

        //shows the submission successful thank you view
        // itemId => the id of the item just created
        // requestType => the text of the type of request just submitted
        function showThankYou(itemId,requestType){
            attachmentFiles = [];
            //fill in the item id and the type of request
            $("#intakeFormThankYou #requestType").html(requestType);
            $("#intakeFormThankYou #itemId").html("Item ID #"+itemId);

            //hide the form selection, form footer, and form buttonContainer
            $("#formselectionContainer, #intakeFormFooter, #intakeFormContainer").addClass("hidden");
            //show the thank you buttonContainer
            $("#intakeFormThankYou").removeClass("hidden");
            //scroll the page up
            $('html, body').animate({
                scrollTop: ($('#intakeFormContentContainer').offset().top)
            },500);
        }

        //resets the form view to be like on page load
        function resetForm(){
          //reset text fields with a blank value
          $(".formInput[type='text']").val("");
          //reset the textareas
          $("textarea").val("");
          //reset the date picker to the default value
          $("#publishDateInput").val("");
          //reset the product group
          $("#productGroupInput").val("");
          //reset the drop down boxes to the first option
          $("select").val("");
          //reset the attachment input
          $("#attachmentInput").val(null);
          //remove all valid, invalid, correct, and incorrect classes from all inputs
          $(".formInput").removeClass("valid invalid incorrect_response correct_response correct_color incorrect_color");
          //hide the thank you buttonContainer
          $("#intakeFormThankYou").addClass("hidden");
          //hide the form container
          $("#intakeFormContainer").addClass("hidden");
          //make sure none of the form selections are selected
            $(".typeOfRequest").removeClass("selected");
          //remove text from the footer
          $("#intakeFormFooter").html("");
          //show the selection container and footer
            $("#formselectionContainer, #intakeFormFooter").removeClass("hidden");
        }


        //sets the greeting at the top of the form to be the current users first name
        //as well we the name, date, and time in the top banner
        function setGreetingName(){
          return $.ajax({
              url: siteUrl + "/_api/web/currentUser",
              Type:'GET',
              headers: {
                accept: "application/json;odata=verbose"
              }
            }).done(function(data){
                //set the greeting to be the first name of the returned user
                $("#formGreeting").html("Hi, "+ data.d.Title.substring(0,data.d.Title.indexOf(" ")));
                //set th date and time text in the top banner
                var date = new Date();
                var weekDay = daysOfTheWeek[date.getDay()];
                var month = monthsOfTheYear[date.getMonth()];
                var day = date.getDate();
                var year = date.getFullYear();
                var minute = date.getMinutes() < 10 ? "0"+date.getMinutes() : date.getMinutes();
                var second = date.getSeconds() < 10 ? "0"+date.getSeconds() : date.getSeconds();
                var time = date.getHours() >= 0 && date.getHours() <= 11 ?
                 ((date.getHours() + 11) % 12 + 1 )+":"+minute+":"+second+" AM" : ((date.getHours() + 11) % 12 + 1 )+":"+minute+":"+second+" PM" ;
                var name = data.d.Title;
                var dateTimeString = weekDay + ", " + month + " " + day + ", " + year + " | " + time + " " +  name
                $("#formDateTime").html(dateTimeString);
            });
        }

        //reads the file provided as a url data url stringify
        //file => the file to read, needs to be a blob or file object
        //onSuccess => function to run if the read operation completes
        //onFail => function to run if the read operation fails
        function readFile(file,onSuccess,onFail){
          var fileType = file.name.substr(file.name.indexOf("."));
          var videoExtentions = [".mp4",".avi", ".mov", ".wmv"];
          //deferred object to resolve or reject after the file is read
          var deferred = $.Deferred();
          //if the file being read is a video throw and error and alert the user that videos cannot be attached
          if(videoExtentions.indexOf(fileType) != -1){
            alert("video files cannot be attached");
            throw new Error("Cannot read video files");
          }
          //if the file is undefined there is not file to read so resolve the promise
          else if(typeof file == "undefined"){
            deferred.resolve("No file to read");
          }
          //if the file is not undefined and not a video set up callbacks and begin reading the file
          else{
            var reader = new FileReader();
            reader.onload = function(data){
              //pass the file data and the name of the file to the success callback
              onSuccess(data,file.name);
              deferred.resolve("file read sucessfully");
            };
            reader.onerror = function(data){onFail(data); deferred.resolve("file read failed");};
            //begin reading the file
            reader.readAsArrayBuffer(file);
          }

          return deferred.promise();
        }

        //callback functions for when a file read succeeds or fails
        function fileReadSucess(fileArray,fileName){
          //if the read operation completes
          //create and object containing the file array and the file name
          //then add that object to the attachedFileData array
          var fileData = {
            fileString:fileArray.target.result,
            fileName: fileName
          }
          attachedFileData.push(fileData);
          console.log(attachedFileData);
          // add valid
          $("#attachmentInput").addClass("valid");
        }
        function fileReadFail(){
          //add invalid
          $("#attachmentInput").addClass("invalid");
        }



        //attachs all necessary event handlers
        function attachEvents(){
          //event handler for the add list item button
          //creaes a new list item based on form information
          $("#addBtn").on("click",function(){
            //check if the submit button is disabled
            //this will prevent multiple multiple submissions being made at the same time
            if(!$("#addBtn").hasClass("disabled")){
              //if the button wasn't disabled, disable it
              $("#addBtn").addClass("disabled");

              //set a timer to display a loading icon if the submission is taking longer then 1 second
              loadingTimer = setTimeout(function(){
                  $("#submitLoadingImage").removeClass("hidden");
                  $("#submitLoadingText").removeClass("hidden");
              },1000);

              //emtpy the attachedFileData array
              attachedFileData = [];
              //only gather the data and create the list once the form has been validated
              $.when(validateForm()).then(function(msg){
                var itemData = gatherFormData();
                createListItem(itemData,attachedFileData);
              },function(msg){
                //if the form was not validated show why
                console.log(msg);
                //unlock the submit button
                //if the button wasn't disabled, disable it
                $("#addBtn").removeClass("disabled");
              });
            }
          });


          //event handler for the people picker input box
          //check when the user has stopped typing and runs a people serach
          $("#ownerInput, #coownerInput").on("keyup",function(){
            //the value in the input box after the user has stopped typing
            var typedVal = $(this).val();
            var inputId = $(this).attr("id");


            if(typedVal !== ""){
              //if the user stops typing for 1 second check if the value they have
              //input is a valid user
              clearTimeout(peoplePickerTimer);
              peoplePickerTimer = setTimeout(function(){
                  searchForUser(typedVal,inputId);
              },750);
            }
            else{
              $(this).removeClass("incorrect_color");
              $(this).removeClass("incorrect_response");
            }
          });
          //clears the people search timer when the user resumes typing
          $("#ownerInput, #coownerInput").on("keydown",function(){
            //stop showing the loading icon
            clearTimeout(peoplePickerTimer);
          });


          //shows and hides the example image
          $(".seeExampleButton").on("click", function(){
            if($(this).next().hasClass("hidden")){
              $(this).next().removeClass("hidden");
            }
            else{
                $(this).next().addClass("hidden");
            }
          });

          //swaps the form content on the page
          $('#formSelectionItem .typeOfRequest').on("click",function(){
            $('.typeOfRequest').removeClass("selected");
            $(this).addClass("selected");
            var selectedForm = $(this).attr("data-form");
            var footer = $(this).attr("data-footerVal");
            swapFormContent(selectedForm,footer);

          });

          // events for the thank you screen button
          //hides the thank you screen and shows the form exactly as it was before submitting
          $("#editBtn").on("click",function(){
            window.location = "https://microsoft.sharepoint.com/sites/Infopedia_G02/Pages/WDG-Open-Tickets-POC.aspx";
          });
          //resets the form view to be exactly as it was when the page loaded
          $("#newBtn").on("click",function(){
            resetForm();
          });
          //shows the date picker
          $("#publishDateInput").on("click",function(){
            $("#datePicker").removeClass("hidden");
          });
          $("#datePickerClose").on("click",function(){
              $("#datePicker").addClass("hidden");
          });


          /*
          $("#ninjaTile").draggable();

          $('#ninjaButton').on("click",function(){
              $("#ninjaCat").animate({
                left:"-200px"
              },500,function(){
                console.log("Animated off screen");
                $("#ninjaCat").removeClass("hidden");
              }).promise().done(function(){
                $("#ninjaCat").animate({
                  left:"1000px"
                },3500,function(){
                  $("#ninjaCat").addClass("hidden");
                });
              });
            }); */

          //event for the display list items button, displays all list items
          //used just for testing purposes, will be removed later
          /*$("#displayContainer #displayBtn").on("click",function(){
            $.ajax({
              url: siteUrl + "/_api/web/lists/getbytitle('New Intake Form Test')/items",
              Type:'GET',
              headers: {
                accept: "application/json;odata=verbose"
              }
            }).done(function(data){
              var allListItems = [];
              data.d.results.forEach(function(val,i){
                allListItems.push("<li>"+val.Title+"</li>");
                console.log(data);
              });
              console.log(allListItems);
              allListItems.forEach(function(val,i){
                $("#listItemContainer ul").html(val);
              });
            });
          });*/



        }
    }
    </script>
  </head>
    <body>
      <div id="intakeFormContentContainer">
          <div id="intakeFormHeader" class="intakeFormBanner"><div>Virtual Help Desk   |  Windows Ready/Devices Group</div><div id="formDateTime"></div></div>
        <div id="intakeFormThankYou" class="hidden">
          <h1>Thank you for your request!</h1><br/>
          <h1 id="requestType"></h1><br/>
          <h1 id="itemId"></h1></br>
          <div>Our team will review your request details, and reach out if we have any questions.</div><br/>
          <div>To check the status, or look up previous requests, please visit our (link to intake dashboard here)</div><br/>
          <div id="editBtn" class="inputBtn thankYouBtn">Edit/View the item</div>
          <div id="newBtn" class="inputBtn thankYouBtn">Open a new form</div>
          <div> Email us at  <a href="mailto:WDGPublishing@microsoft.com" class="hyperLinkBlue">WDGPublishing@microsoft.com</a> for more help</div>
        </div>
        <div id="formselectionContainer" class="hidden"> <!---->
          <!--
          <div id="ninjaTile"></div>
          <img id="ninjaButton" src="https://microsoft.sharepoint.com/teams/Infopedia_Team_Site/Projects%20Folder/Trey%20Test%20Stuff/red-button.png"></img>
          <img id="ninjaCat" class="hidden" src="https://microsoft.sharepoint.com/teams/Infopedia_Team_Site/Projects%20Folder/Trey%20Test%20Stuff/ninja_cat.gif"></img>-->
          <div id="selectionLinks">
            <a href="https://microsoft.sharepoint.com/sites/Infopedia_G02/Pages/WindowsReadyProductionDashboard.aspx">View My Requests</a> |
            <a href="https://forms.office.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbR-eo3tun4ppHoGXuly7ZAKtUNEFEUDJKNFM0TllDN05LT0NCSFJIQjI5Qi4u">Give Feedback</a>
          </div>
          <p id="formGreeting">Hi,</p>
          <p>What would you like assistance with today?</p>
          <div class="flexibleDisplay">
            <p>I would like to</p>
            <div id="formSelectionItem">
              <div class="typeOfRequest" data-form="Form1" data-footerVal="New /Learning Publishing Request: Windows Devices Group - Publishing Request (add new content) ">add new content</div>
              <div class="typeOfRequest" data-form="Form2" data-footerVal="New /Learning Publishing Request: Windows Devices Group - Publishing Request (update existing content) ">update existing content</div>
              <div class="typeOfRequest" data-form="Form3" data-footerVal="New /Learning Publishing Request: Windows Devices Group - Publishing Request (remove content) ">remove content</div>
              <div class="typeOfRequest" data-form="Form4" data-footerVal="New /Learning Publishing Request: Windows Devices Group - Publishing Request (request multiple items) ">request multiple items</div>
              <div class="typeOfRequest" data-form="Form5" data-footerVal="New /Learning Publishing Request: Windows Devices Group - Publishing Request (do something not listed here) ">do something not listed here</div>
            </div>
          </div>
        </div>
        <div id="intakeFormFooter" class="intakeFormBanner"><div></div></div>
        <div id="intakeFormContainer" class="hidden"> <!---->
          <div class="intakeFormSection Form1">
            <p>Use this form to add new content</p>
          </div>
          <div class="intakeFormSection Form2">
            <p>Use this form to update an asset.</p>
          </div>
          <div class="intakeFormSection Form3">
            <p>Use this form for a request to delete, hide, or remove content from Learning, page, or card.</p>
          </div>
          <div class="intakeFormSection Form4">
            <p>Use this form for requests that require multiple actions. (Note requests with more then 5 items require a BOM template.)</p>
          </div>
          <div class="intakeFormSection Form5">
            <p>Use this form for a request not listed as a choice, or you are not sure what type of request it is, or complex project.</p>
          </div>
          <div class="intakeFormSection Form1 Form2">
            <P>See example</p>
            <div class="seeExampleButton"></div>
            <img src="https://microsoft.sharepoint.com/teams/Infopedia_Team_Site/Projects%20Folder/Trey%20Test%20Stuff/examples/FormResource.png" class="hidden seeExampleImage"/>
          </div>
          <div class="intakeFormSection  Form3">
            <P>See example</p>
            <div class="seeExampleButton"></div>
            <img src="https://microsoft.sharepoint.com/teams/Infopedia_Team_Site/Projects%20Folder/Trey%20Test%20Stuff/examples/FormResource2.png" class="hidden seeExampleImage"/>
          </div>
          <div class="intakeFormSection Form4">
            <P>See example</p>
            <div class="seeExampleButton"></div>
            <img src="https://microsoft.sharepoint.com/teams/Infopedia_Team_Site/Projects%20Folder/Trey%20Test%20Stuff/examples/FormResource3.png" class="hidden seeExampleImage"/>
          </div>
          <div class="intakeFormSection Form5">
            <P>See example</p>
            <div class="seeExampleButton"></div>
            <img src="https://microsoft.sharepoint.com/teams/Infopedia_Team_Site/Projects%20Folder/Trey%20Test%20Stuff/examples/FormResource4.png" class="hidden seeExampleImage"/>
          </div>
          <div class="intakeFormSection Form1 Form2 Form3 Form4 Form5">
            <div class="formSectionTitle">Product Group*</div>
            <div class="formSectionInput">
              <select id="productGroupInput" class="requiredInput formInput" data-property="ProductGroup">
                <option disabled selected value> -- select an option -- </option>
                <option value="Windows">Windows</option>
                <option value="Devices">Devices</option>
              </select>
            </div>
          </div>
          <div class="intakeFormSection Form3">
            <div class="formSectionTitle">Doc ID or Page/Card URL*</div>
            <div class="formSectionInput">
              <input id="docIdInput" class="requiredInput formInput fillContentArea" data-property="PageURL" type="text" autocomplete="off" placeholder=""></input>
              <div class="subText">
                Please give page URL or Doc ID of asset to be removed
              </div>
            </div>
          </div>
          <div class="intakeFormSection Form4">
            <div class="formSectionTitle">Request Overview*</div>
            <div class="formSectionInput">
              <textarea id="requestOverviewInput" class="requiredInput formInput fillContentArea" data-property="ShortDescription" type="text" autocomplete="off" placeholder="" rows="4" cols="50"></textarea>
              <div class="subText">
                Please provide a brief overview/summary of your request.(e.g. update page, with cards, featuring new items and tags)
              </div>
            </div>
          </div>
          <div class="intakeFormSection Form4">
            <div class="formSectionTitle">
              Request Details*
              <div>(Example)</div>
              <ul>
                <li>Item 1</li>
                <li>Title</li>
                <li>Description</li>
                <li>Confidentiality</li>
              </ul>
              <ul>
                <li>Item 2</li>
                <li>Title</li>
                <li>Description</li>
                <li>Confidentiality</li>
              </ul>
              <ul>
                <li>Item 3</li>
                <li>Title</li>
                <li>Description</li>
                <li>Confidentiality</li>
              </ul>
            </div>
            <div class="formSectionInput">
              <textarea id="requestDetailsInput" class="requiredInput formInput fillContentArea" data-property="RequestDetails" type="text" autocomplete="off" placeholder="" rows="20" cols="50"></textarea>
              <div class="subText">
                Please provide specific and granular details of your request.
              </div>
            </div>
          </div>
          <div class="intakeFormSection Form4">
            <div class="formSectionTitle">BOM Template</div>
              <div class="formSectionInput">
                <div class="subText">
                  If you have multiple items in your request, please download the appropriate BOMs below.
                </div>
                <a href="https://microsoft.sharepoint.com/sites/infopedia/pages/layouts/KCDoc.aspx?k=G02KC-1-10621&downloadnow=1" class="hyperLinkBlue">Asset BOM Template</a><br/>
                <a href="https://microsoft.sharepoint.com/sites/infopedia/pages/layouts/KCDoc.aspx?k=G02KC-1-10622&downloadnow=1" class="hyperLinkBlue">Card BOM Template</a>
                <div class="subText">
                  Fill it out, and attach to your request below.
                </div>
              </div>
            </div>
          <div class="intakeFormSection Form5">
            <div class="formSectionTitle">Details</div>
            <div class="formSectionInput">
              <textarea id="detailsInput" class="optionalInput formInput fillContentArea" data-property="ShortDescription" type="text" autocomplete="off" placeholder="" rows="4" cols="50"></textarea>
              <div class="subText">
                Please provide all required information or attach detailed instructions.
              </div>
            </div>
          </div>
          <div class="intakeFormSection Form1 Form2 Form4">
            <div class="formSectionTitle">Source File Location</div>
            <div class="formSectionInput">
              <input id="sourceFileLocationInput" class="optionalInput formInput fillContentArea" data-property="SourceFileLocation" type="text" autocomplete="off" placeholder=""></input>
              <div class="subText">
                (location of files to download)
              </div>
            </div>
          </div>
          <div class="intakeFormSection Form1 Form2 Form4 Form5">
            <div class="formSectionTitle">Attachments</div>
            <div class="formSectionInput">
              <input id="attachmentInput" class="formInput" data-property="Attachments" type="file" placeholder="" multiple></input>
            </div>
          </div>
          <div class="intakeFormSection Form1 Form2 Form3">
            <div class="formSectionTitle">File Name*</div>
            <div class="formSectionInput">
              <input id="fileNameInput" class="requiredInput formInput fillContentArea" data-property="FileName" type="text" autocomplete="off" placeholder=""></input>
            </div>
          </div>
          <div class="intakeFormSection Form1 Form2">
            <div class="formSectionTitle">Document Title to Display*</div>
            <div class="formSectionInput">
              <input id="documentTitleInput" class="requiredInput formInput fillContentArea" data-property="DocumentTitle" type="text" autocomplete="off" placeholder=""></input>
            </div>
          </div>
          <div class="intakeFormSection Form1 Form2">
            <div class="formSectionTitle">Document Description</div>
            <div class="formSectionInput">
              <textarea id="documentDescriptionInput" class="optionalInput formInput fillContentArea" data-property="ShortDescription" placeholder="" rows="4" cols="50"></textarea>
              <div class="subText">
                Needs to be short and useful for the field. Use key search terms where possible and include enough context so the item makes sense when returned individually in all-Microsoft search results. 225 chars or less.
              </div>
            </div>
          </div>
          <div class="intakeFormSection Form1 Form2">
            <div class="formSectionTitle">Maximum Reach (confidentiality)*</div>
            <div class="formSectionInput">
              <select id="maximumReachInput" class="requiredInput formInput" data-property="Confidentiality">
                <option disabled selected value> -- select an option -- </option>
                <option value="Internal Users (Default - MS Confidental)">Internal Users (Default - MS Confidental)</option>
                <option value="Customer Ready">Customer Ready</option>
                <option value="Partner Ready">Partner Ready</option>
                <option value="Non-Disclosure">Non-Disclosure</option>
              </select>
            </div>
          </div>
          <div class="intakeFormSection Form1 Form2 Form4">
              <div class="formSectionTitle">Content Owner* <div>Must be FTE</div></div>
              <div class="formSectionInput">
                <div class="subText" style="float:left; width:315px;">
                  Owner Alias*
                </div>
                <div class="subText" style="float:left; width:320px;">
                  Co-Owner Alias (Optional)
                </div>
                  <input id="ownerInput" class=" requiredInput formInput" data-property="Owner" type="text" autocomplete="off"></input>
                  <div id="autocomplete" class="hidden"></div>
                  <input id="coownerInput" class="optionalInput formInput" data-property="CoOwner" type="text" autocomplete="off"></input>
                  <div class="subText">
                    Note: Search for the user's alias if their name is not returning the correct result
                  </div>
                  <div id="autocomplete" class="hidden" style="left:494px;"></div>
              </div>
          </div>
          <div class="intakeFormSection Form1">
            <div class="formSectionTitle">Page URL</div>
            <div class="formSectionInput">
              <input id="pageUrlInput" class="optionalInput formInput fillContentArea" data-property="PageURL" type="text" autocomplete="off"  placeholder=""></input>
              <div class="subText">
                On which page(s) and card(s) does this asset belong (URLs)?
              </div>
            </div>
          </div>
          <div class="intakeFormSection Form1 Form2 Form4">
            <div class="formSectionTitle">Requested Publish Date</div>
            <div class="formSectionInput">
              <input type="text" id="publishDateInput" class="optionalInput formInput" data-property="PublishDate" style="width:180px"/>
              <div id="datePicker" class="hidden"></div>
              <div class="subText">
                Note: that there is a 3-business day SLA for publishing. We always aim for earlier completion but for a specific date (for example a planned comm or embargoed content)
                please share that requirement with the WindowsReady Submission alias in advance to accommodate pre-existing deliverables. More advanced notice is always better for us
                to create a workback plan with you.
              </div>
            </div>
          </div>
          <div class="intakeFormSection Form1 Form2 Form3">
            <div class="formSectionTitle">Additional Details</div>
            <div class="formSectionInput">
              <textarea id="additionalDetailsInput" class="optionalInput formInput fillContentArea" data-property="Details" placeholder="" rows="4" cols="50"></textarea>
            </div>
          </div>
          <div id="buttonContainer" class="">
            <div id="addBtn" class="inputBtn">Submit This Request</div>
            <img id="submitLoadingImage" src="https://microsoft.sharepoint.com/teams/Infopedia_Team_Site/Projects%20Folder/Trey%20Test%20Stuff/loading.gif" class="loadingImg hidden"/>
            <div id="submitLoadingText" class="hidden">Please wait while the form is validated and submitted</div>
              <ul>
              </ul>
            </div>
          </div>
          </div>
        </div>
      </div>
    </body>
</html>
