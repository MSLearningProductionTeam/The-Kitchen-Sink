<html>
  <head>
    <style>
      /*global styles*/
      .correct_color{background-color: rgb(28, 203, 33) !important;}
      .incorrect_color{background-color: rgb(251, 51, 51) !important;}
      .hidden{display:none !important;}
      .flexibleDisplay{display: flex;}
      .fillContentArea{min-width: 100%; max-width: 100%;}
      .subText{font-size: 12px; margin: 5px 0 5px 0;}
      .hyperLinkBlue{color:#0061A7 !important;}
      body{background:#E6E6E6!important;}
      textarea{resize: none;}
      .page-title{display:none !important;}

      #contentContainer{position: relative; left: 50%; transform: translateX(-50%); width: 910px; background: white; border-radius: 6px;}
        #listView{width: 895px; margin:0px auto;}
          #intakeFormHeader{margin-bottom: 65px;}
          #columnHeaders{display: flex; font-size: 12px; margin-bottom: 15px; padding: 7px 7px 7px 15px; color:white; background: #243b56; border-radius: 6px;}
            #columnHeaders div:nth-child(1){width:102px;}
            #columnHeaders div:nth-child(2){width:66px;}
            #columnHeaders div:nth-child(3){width:154px;}
            #columnHeaders div:nth-child(4){width:450px;}
            #columnHeaders div:nth-child(5){width:138px;}
          #ticketList{padding:7px 7px 7px 11px;}
            .ticket{display:flex; margin-bottom: 10px; font-size: 13px;}
              .ticket div{padding-right: 10px;}
              .ticket div:nth-child(1){width:102px;}
                .ticket .editBtn{width: 30px !important; height: 30px; font-size: 20px; text-align: center; border: 1px solid lightgray; border-radius: 9px; padding:0; line-height: 13px; cursor: pointer;}
              .ticket div:nth-child(2){width:66px;}
              .ticket div:nth-child(3){width:154px;}
              .ticket div:nth-child(4){width:450px;}
              .ticket div:nth-child(5){width:138px;}
            #addNewRequest{display: flex; padding: 7px 7px 7px 11px}
              #addNewRequest div:nth-child(2){line-height: 27px;}
              #newRequestBtn{background: #243b56; cursor: pointer; color: white; font-size: 27px; width: 30px; height: 30px; border-radius: 6px; text-align: center; font-weight: bold; margin-right: 10px; line-height: 25px;}
          .intakeFormBanner{background:#243b56; padding:10px 15px 5px 15px; color:white; font-size: 14px; font-family: "SegoeUI Light", "Segoe UI","Helvetica Neue",Helvetica,Arial,sans-serif; height:40px; display: flex; justify-content: space-between; border-radius: 6px}
          #formDateTime{float:right; font-size: 14px !important; width:450px; text-align: right;}
          #intakeFormContainer{position: relative; /*left:-1000px;*/ width: 864px; left: 50%; transform: translate3d(-50%,0,0); margin-top:10px; margin-bottom:10px;}
            .intakeFormSection{border: 1px solid rgb(228, 233, 246); display: flex; font-size:14px; margin:-1px;}
              .formSectionTitle{padding:10px; width: 185px; min-width: 185px; border-right: 1px solid rgb(228, 233, 246); text-align: right; font-family: "SegoeUI Light", "Segoe UI","Helvetica Neue",Helvetica,Arial,sans-serif;}
                .formSectionTitle ul li{list-style-type: none; font-size:12px; }
              .formSectionInput{margin:10px; flex-grow: 1; align-self: center;}
                #ownerInput{width: 295px;}
                #coownerInput{width: 295px;}
                .formInput{color:black !important;}
            #buttonContainer{display:flex; flex-direction: column;}
              .inputBtn{cursor: pointer; background:#243b56; padding:10px; margin-right:10px; color:white; text-align: center;}
              .loadingImg{width: 20px; height: 20px; margin: 0px auto;}
              #submitLoadingText{margin:5px; text-align: center;}
              #addBtn{width:200px; font-size: 14px;margin: 0px auto; margin-bottom: 5px; margin-top: 5px; border-radius: 6px;}
              #cancelBtn{width:130px; font-size: 12px;margin: 0px auto; margin-bottom: 5px; margin-top: 5px; cursor:pointer; text-align: center;}
    </style>
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous">
    </script>
    <script>
      window.onload = function(){
        //globals variables
        //absolute site collection url
        var siteUrl;
        //array tha contains all returned user list items
        var listItems;
        //an array of list item properties
        //used to specify which of the returned list item properties will be used in the program
        //and which form input field the list property value is be placed in
        var properties;
        //array of days in the week
        var daysOfTheWeek;
        //array of the months in the year
        var monthsOfTheYear;
        //array of possible values for the footer banner
        var footerValues;
        //the sharepoint id of the item currently being edited
        var currentEditItemId;

        //call the initalize function
        init();

        //initialization function
        function init(){
          //define the global variables
          if(typeof _spPageContextInfo !== 'undefined'){siteUrl = _spPageContextInfo.webAbsoluteUrl;}
          listItems = [];
          properties = ["Attachments","CoOwner","Comments","Confidentiality","Details","DocumentTitle","FileName","Owner","PageTitle","PageURL","ProductGroup","PublishDate","RequestDetails","ShortDescription","SourceFileLocation"];
          daysOfTheWeek = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturdate"];
          monthsOfTheYear = ["January","February","March","April","May","June","July","August","September","October","November","December"];
          footerValues = [
            "New /Learning Publishing Request: Windows Devices Group - Publishing Request (add new content)",
            "New /Learning Publishing Request: Windows Devices Group - Publishing Request (update existing content)",
            "New /Learning Publishing Request: Windows Devices Group - Publishing Request (remove content)",
            "New /Learning Publishing Request: Windows Devices Group - Publishing Request (request multiple items)",
            "New /Learning Publishing Request: Windows Devices Group - Publishing Request (do something not listed here)"
          ];
          //start the program by getting the current user
          getUser();
        }

        //gets the current user's sharepoint profile info
        function getUser(){
          $.ajax({
              url: siteUrl + "/_api/web/currentUser",
              Type:'GET',
              headers: {
                accept: "application/json;odata=verbose"
              }
          }).done(function(data){
            //set the date and time in the top banner
            setDateAndTime(data.d.Title);
            //get user list items
            //the query string to specify what items are returned for the user's list items
            var query = "?$select=ID,RequestType1,Title,Created,TimeStamp,RequestDetails,Attachments,SourceFileLocation,ShortDescription,Confidentiality,ProductGroup,Comments,Details,DocumentTitle,FileName,PageTitle,RequestTypeTitle,Owner,CoOwner,PublishDate,PageURL&$orderby=ID%20desc&$filter=RequestType1 ne 'Update Existing Ticket' and Request_x0020_State ne 'Completed' and Request_x0020_State ne 'Rejected'";
            getUserListItems(data.d.Id,query);
          });
        }

        //gets all of the list items for the user based on the query string specified
        //userId => the id of the user, returned by getUser
        //queryString => string that specifies the parameters of the search for the users list items
        function getUserListItems(userId,queryString){
          $.ajax({
              url: siteUrl + "/_api/web/lists/GetByTitle('WDGIntakeForm')/items"+queryString+" and AuthorId eq "+userId+"",
              Type:'GET',
              headers: {
                accept: "application/json;odata=verbose"
              }
          }).done(function(data){
            //if no items were returned add text to the list that says the user has no items
            if(data.d.results.length <= 0){
              var htmlString = "<div style='text-align:center;'>You have no open tickets</div>";
              $("#ticketList").append(htmlString);
            }
            else{
              //otherwise loop through the returned results and add each to the listItems array
              $.each(data.d.results,function(i,val){
                //add each list item to the global object
                listItems.push(this);
                //add each list item to the screen
                var htmlString = "<div class='ticket' data-ticketNum='"+i+"' data-requestType='"+this.RequestType1+"' data-listId='"+this.ID+"'><div><div class='editBtn'>...</div></div><div>"+this.ID+"</div><div>"+this.RequestType1+"</div><div>"+this.Title+"</div><div>"+this.Created.substring(0,10)+"</div>";
                $("#ticketList").append(htmlString);
              });
              //attach the needed events
              attachEvents();
            }
          });
        }

        //attachs all the events the program needs to function
        function attachEvents(){
            //the click even on each list item edit button
            $(".editBtn").on("click",function(){
              //the id of the list item on sharepoint
              currentEditItemId = $(this).parent().parent().attr("data-listId");
              //the number of the ticket clicked on, specified in the html
              //this number cooresponds to the tickets position in the listItems array
              var ticketNum = $(this).parent().parent().attr("data-ticketNum");
              //show the edit item view
              showEditView(ticketNum);
            });
            //submit button click event
            $("#addBtn").on("click",function(){
              //submit the information provied to the sharepoint list
              submitChangeRequest(currentEditItemId);
            });
            //go back button click event
            $("#cancelBtn").on("click",function(){
              //cloes the edit view
              closeForm();
            });
            //new request click event
            $("#newRequestBtn").on("click",function(){
              //redirects back to the intake form page
              window.location = "https://microsoft.sharepoint.com/sites/Infopedia_G02/Pages/WDG-Intake-Form-POC.aspx";
            });
        }
        //shows the list item edit view
        //ticketNum => the position of the list item to edit in the listItems array
        function showEditView(ticketNum){
          //the object containing all the list item data
          var ticket = listItems[ticketNum];
          //the type of form that the ticket data should be shown in, based on the request type
          //this is used to set the text in the footer as well as show the correct form class
          var formType;
          switch(ticket.RequestType1){
            case "add new content":
              formType = 0;
              break;
            case "update existing content":
              formType = 1
              break;
            case "remove content":
              formType = 2;
              break;
            case "request multiple items":
              formType = 3;
              break;
            case "do something not listed here":
              formType = 4;
              break;
          }
          //loop though the properties array and check each property in the ticket object
          $.each(properties,function(i,val){
            //if the specified property is null then no value was provided when the initial form was submitted
            //if the value is not null then a value was provided and we should fill that value into the correct form input
            if(ticket[val] !== null){
              $(".formInput[data-property='"+val+"']").val(ticket[val]);
            }
          });
          //update the text in the footer
          $("#intakeFormFooter").html(footerValues[formType]);
          //hide all intake sections
          $(".intakeFormSection").addClass("hidden");
          //show the correct form
          $(".Form"+(formType + 1)).removeClass("hidden");
          //hide the list view
          $("#listView").addClass("hidden");
          //show the form view
          $("#formView").removeClass("hidden");
        }

        //updates the sharepoint list item's changeReason and changeRequest fields with the change request information
        //itemId => the id of the list item on sharepoint
        function submitChangeRequest(itemId){
          //only proceed with the http request after the provided information has been valideted and the form digest and list type have been obtained
            $.when(
              validation(),
              getFormDigest(),
              getListType()
            ).then(function(validation,digest,listType){
              //gather the data to send
              var formData = gatherFormData();
              $.ajax({
                  url: siteUrl + "/_api/web/lists/getbytitle('WDGIntakeForm')/items("+itemId+")",
                  type: "POST",
                  contentType: "application/json;odata=verbose",
                  data: JSON.stringify(formData),
                  headers: {
                      "Accept": "application/json;odata=verbose",
                      "X-RequestDigest": digest[0].d.GetContextWebInformation.FormDigestValue,
                      "X-HTTP-Method": "MERGE",
                      "If-Match": "*"
                  },
                  success: function (successData) {
                    alert(" Your request was sucessfully submitted");
                    //close the form
                    closeForm();
                  },
                  error: function (data) {
                    alert("There was an issue submitting your request");
                    console.log(data);
                    closeForm();
                  }
              });

            });
        }
        //validates the provided information
        function validation(){
          var promise = $.Deferred();
          //check that each required input has been filled in and the value provided is not null
            $(".requiredInput").each(function(){
              //if empty or null mark as invalid
              if($(this).val() == "" || $(this).val() == null){
                $(this).addClass('invalid');
                $(this).addClass('incorrect_color');
                $(this).removeClass("valid");
              }
              //otherwise the input is valid
              else{
                $(this).addClass("valid");
                $(this).removeClass('incorrect_color');
                $(this).removeClass("invalid");
              }
            });
            //if any required inputs have been marked as invalid reject the promise
            if($(".requiredInput").hasClass("invalid")){
              alert("Please fill in all required fields");
              promise.reject("All required fields were not filled in");
            }
            //otherwise resolve the promise
            else{
              promise.resolve("All fields filled in");
            }

          return promise.promise();
        }

      //get a new digest value for the Form
      //the digest value prevents the same form submission from being applied multiple times
      function getFormDigest() {
          return $.ajax({
              url: siteUrl + "/_api/contextinfo",
              method: "POST",
              headers: { "Accept": "application/json; odata=verbose" },
              success: function(data){
                console.log("Obtained new form digest " +data.d.GetContextWebInformation.FormDigestValue);
              }
          });
      }

      //gets the SP list type
      //used when making an api request
      function getListType(){
        return $.ajax({
          url: siteUrl + "/_api/web/lists/getbytitle('WDGIntakeForm')/items",
          Type:'GET',
          headers: {
            accept: "application/json;odata=verbose"
          },
          success: function(data){
            console.log("Obtained list type: "+data);
          }
        });
      }
      //gathers the data provided in the form and returns an object containing that data
      function gatherFormData(){
        var itemData = {
          '__metadata': {'type': "SP.Data.WDGIntakeFormListItem"},
        };
        //add each valid input to the item data object
        $(".formInput.valid").each(function(){
            itemData[$(this).attr("data-property")] = $(this).val();
        });
        return itemData;
      }
      //closes the form view and shows the list view
      function closeForm(){
        //clear all input values
        $(".formInput").val("");
        //remove and validation classes
        $(".formInput").removeClass("valid invalid incorrect_color");
        //hide the form view
        $("#formView").addClass("hidden");
        //show the list view
        $("#listView").removeClass("hidden");
      }
      //sets the dat and time string that is appended to the top banner
      function setDateAndTime(userName){
        //make a new date object
        var date = new Date();
        //get the day of the week
        var weekDay = daysOfTheWeek[date.getDay()];
        //get the month
        var month = monthsOfTheYear[date.getMonth()];
        //get the day
        var day = date.getDate();
        //get the year
        var year = date.getFullYear();
        //get the minute
        //if the minute returned is less then 10 add a 0 to it so that it maintains the double digit format
        var minute = date.getMinutes() < 10 ? "0"+date.getMinutes() : date.getMinutes();
        //get the second
        var second = date.getSeconds() < 10 ? "0"+date.getSeconds() : date.getSeconds();
        //get the hour
        //since the hour is returned in 24 format, reformat the time
        var time = date.getHours() >= 0 && date.getHours() <= 11 ?
         ((date.getHours() + 11) % 12 + 1 )+":"+minute+":"+second+" AM" : ((date.getHours() + 11) % 12 + 1 )+":"+minute+":"+second+" PM" ;
         //combine all variables into a single string
        var dateTimeString = weekDay + ", " + month + " " + day + ", " + year + " | " + time + " " +  userName;
        //add the string to the banner
        $("#formDateTime").html(dateTimeString);
      }

    }
    </script>
    <body>
      <div id="contentContainer">
        <div id="intakeFormHeader" class="intakeFormBanner"><div>Virtual Help Desk   |  Windows Ready/Devices Group - My Requests</div><div id="formDateTime"></div></div>
        <div id="listView">
          <div id="columnHeaders">
            <div id="editColumn">Edit</div>
            <div id="idColumn">ID</div>
            <div id="requestTypeColumn">Request Type</div>
            <div id="titleColumn">Title</div>
            <div id="createdColumn">Created</div>
          </div>
          <div id="ticketList"></div>
          <div id="addNewRequest"><div id="newRequestBtn">+</div><div>Add New Request</div></div>
          </div>
        <div id="formView" class="hidden">
          <div id="intakeFormFooter" class="intakeFormBanner"><div></div></div>
          <div id="intakeFormContainer">
            <div class="intakeFormSection Form1 Form2 Form3 Form4 Form5">
              <div class="formSectionTitle">Product Group*</div>
              <div class="formSectionInput">
                <input id="productGroupInput" class="formInput" data-property="ProductGroup" type="text" autocomplete="off" placeholder="" disabled></input>
              </div>
            </div>
            <div class="intakeFormSection Form3">
              <div class="formSectionTitle">Doc ID or Page/Card URL*</div>
              <div class="formSectionInput">
                <input id="docIdInput" class=" formInput fillContentArea" data-property="PageURL" type="text" autocomplete="off" placeholder="" disabled></input>
              </div>
            </div>
            <div class="intakeFormSection Form4">
              <div class="formSectionTitle">Request Overview*</div>
              <div class="formSectionInput">
                <textarea id="requestOverviewInput" class=" formInput fillContentArea" data-property="ShortDescription" type="text" autocomplete="off" placeholder="" rows="4" cols="50" disabled></textarea>
              </div>
            </div>
            <div class="intakeFormSection Form4">
              <div class="formSectionTitle">
                Request Details*
                <div>(Example)</div>
                <ul>
                  <li>Item 1</li>
                  <li>Title</li>
                  <li>Description</li>
                  <li>Confidentiality</li>
                </ul>
                <ul>
                  <li>Item 2</li>
                  <li>Title</li>
                  <li>Description</li>
                  <li>Confidentiality</li>
                </ul>
                <ul>
                  <li>Item 3</li>
                  <li>Title</li>
                  <li>Description</li>
                  <li>Confidentiality</li>
                </ul>
              </div>
              <div class="formSectionInput">
                <textarea id="requestDetailsInput" class=" formInput fillContentArea" data-property="RequestDetails" type="text" autocomplete="off" placeholder="" rows="20" cols="50" disabled></textarea>
              </div>
            </div>
            <div class="intakeFormSection Form5">
              <div class="formSectionTitle">Details</div>
              <div class="formSectionInput">
                <textarea id="detailsInput" class=" formInput fillContentArea" data-property="ShortDescription" type="text" autocomplete="off" placeholder="" rows="4" cols="50" disabled></textarea>
              </div>
            </div>
            <div class="intakeFormSection Form1 Form2 Form4">
              <div class="formSectionTitle">Source File Location</div>
              <div class="formSectionInput">
                <input id="sourceFileLocationInput" class=" formInput fillContentArea" data-property="SourceFileLocation" type="text" autocomplete="off" placeholder="" disabled></input>
              </div>
            </div>
            <div class="intakeFormSection Form1 Form2 Form4 Form5">
              <div class="formSectionTitle">Attachments</div>
              <div class="formSectionInput">
                <input id="attachmentInput" class="formInput" data-property="Attachments" type="text" placeholder="" multiple disabled></input>
              </div>
            </div>
            <div class="intakeFormSection Form1 Form2 Form3">
              <div class="formSectionTitle">File Name*</div>
              <div class="formSectionInput">
                <input id="fileNameInput" class=" formInput fillContentArea" data-property="FileName" type="text" autocomplete="off" placeholder="" disabled></input>
              </div>
            </div>
            <div class="intakeFormSection Form1 Form2">
              <div class="formSectionTitle">Document Title to Display*</div>
              <div class="formSectionInput">
                <input id="documentTitleInput" class=" formInput fillContentArea" data-property="DocumentTitle" type="text" autocomplete="off" placeholder="" disabled></input>
              </div>
            </div>
            <div class="intakeFormSection Form1 Form2">
              <div class="formSectionTitle">Document Description</div>
              <div class="formSectionInput">
                <textarea id="documentDescriptionInput" class=" formInput fillContentArea" data-property="ShortDescription" placeholder="" rows="4" cols="50" disabled></textarea>
              </div>
            </div>
            <div class="intakeFormSection Form1 Form2">
              <div class="formSectionTitle">Maximum Reach (confidentiality)*</div>
              <div class="formSectionInput">
                <input id="maximumReachInput" class=" formInput fillContentArea" data-property="Confidentiality" type="text" autocomplete="off" placeholder="" disabled></input>
              </div>
            </div>
            <div class="intakeFormSection Form1 Form2 Form4">
                <div class="formSectionTitle">Content Owner* <div>Must be FTE</div></div>
                <div class="formSectionInput">
                  <div class="subText" style="float:left; width:315px;">
                    Owner Alias*
                  </div>
                  <div class="subText" style="float:left; width:320px;">
                    Co-Owner Alias (Optional)
                  </div>
                    <input id="ownerInput" class="  formInput" data-property="Owner" type="text" autocomplete="off" disabled></input>
                    <div id="autocomplete" class="hidden"></div>
                    <input id="coownerInput" class=" formInput" data-property="CoOwner" type="text" autocomplete="off" disabled></input>
                </div>
            </div>
            <div class="intakeFormSection Form1">
              <div class="formSectionTitle">Page URL</div>
              <div class="formSectionInput">
                <input id="pageUrlInput" class=" formInput fillContentArea" data-property="PageURL" type="text" autocomplete="off"  placeholder="" disabled></input>
              </div>
            </div>
            <div class="intakeFormSection Form1 Form2 Form4">
              <div class="formSectionTitle">Requested Publish Date</div>
              <div class="formSectionInput">
                <input type="text" id="publishDateInput" class=" formInput" data-property="PublishDate" style="width:180px" disabled/>
              </div>
            </div>
            <div class="intakeFormSection Form1 Form2 Form3">
              <div class="formSectionTitle">Additional Details</div>
              <div class="formSectionInput">
                <textarea id="additionalDetailsInput" class=" formInput fillContentArea" data-property="Details" placeholder="" rows="4" cols="50" disabled></textarea>
              </div>
            </div>
            <div class="intakeFormSection Form1 Form2 Form3 Form4 Form5">
              <div class="formSectionTitle">Change Reason*</div>
              <div class="formSectionInput">
                <textarea id="changeReasonInput" class="requiredInput formInput fillContentArea" data-property="ChangeReason" placeholder="" rows="8" cols="50"></textarea>
                <div class="subText">
                  What is the reason you would like to make a change to the ticket?
                </div>
              </div>
            </div>
            <div class="intakeFormSection Form1 Form2 Form3 Form4 Form5">
              <div class="formSectionTitle">Change Request*</div>
              <div class="formSectionInput">
                <textarea id="changeRequestInput" class="requiredInput formInput fillContentArea" data-property="ChangeRequest" placeholder="" rows="8" cols="50"></textarea>
                <div class="subText">
                  What is the specific change you would like to make.
                </div>
              </div>
            </div>
            <div id="buttonContainer" class="">
              <div id="addBtn" class="inputBtn">Submit This Request</div>
              <img id="submitLoadingImage" src="https://microsoft.sharepoint.com/teams/Infopedia_Team_Site/Projects%20Folder/Trey%20Test%20Stuff/loading.gif" class="loadingImg hidden"/>
              <div id="submitLoadingText" class="hidden">Please wait while the form is validated and submitted</div>
              <div id="cancelBtn" class="">Go Back</div>
              </div>
            </div>
          </div>
        </div>
    </body>
  </head>
</html>
